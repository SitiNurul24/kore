<!-- File: src/views/Accounting.vue -->
<template>
  <div class="p-6 bg-gray-100 min-h-screen">
    <h2 class="text-xl font-bold mb-4">Accounting</h2>

    <!-- List/Search View -->
    <div v-if="!showForm" class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-2">Payable</h3>

        <!-- Search Input -->
        <div class="relative w-full md:w-1/3 mb-6">
          <input
            type="text"
            v-model="searchQuery"
            placeholder="Search"
            class="w-full p-3 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
          />
          <span class="material-icons absolute right-3 top-3 text-gray-400">search</span>
        </div>

        <!-- Table / Loading / Error -->
        <div>
          <div v-if="loading" class="py-10 text-center text-gray-500">
            Memuat data payable...
          </div>

          <div v-else-if="errorMessage" class="py-10 text-center text-red-500 space-y-3">
            <p>{{ errorMessage }}</p>
            <button
              @click="loadTransactions"
              class="inline-flex items-center gap-1 px-4 py-2 bg-[#02A2DC] text-white rounded-md hover:bg-[#0191b8]"
            >
              Muat ulang
              <span class="material-icons text-sm">refresh</span>
            </button>
          </div>

          <div v-else>
            <div
              v-if="filteredTransactions.length === 0"
              class="py-10 text-center text-gray-500 border border-dashed border-gray-300 rounded"
            >
              Data payable tidak tersedia.
            </div>

            <div v-else>
              <div class="overflow-x-auto border border-gray-200 rounded">
                <table class="min-w-[1200px] w-full text-sm table-fixed">
                  <thead class="bg-[#02A2DC] text-white font-bold">
                    <tr>
                      <th class="p-4 border text-center" style="width: 15%">Document<br />Number</th>
                      <th class="p-4 border text-center" style="width: 15%">Doc Ref</th>
                      <th class="p-4 border text-center" style="width: 15%">Doc Date</th>
                      <th class="p-4 border text-center" style="width: 15%">Supplier</th>
                      <th class="p-4 border text-center" style="width: 15%">Local Amount</th>
                      <th class="p-4 border text-center" style="width: 10%">Company</th>
                      <th class="p-4 border text-center" style="width: 15%">Description</th>
                      <th class="p-4 border text-center" style="width: 7%">Status</th>
                      <th class="p-4 border text-center" style="width: 10%">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr
                      v-for="(item, index) in paginatedTransactions"
                      :key="item.recordId || index"
                      class="text-center hover:bg-gray-50"
                    >
                      <td class="p-4 border">{{ item.docNo || '-' }}</td>
                      <td class="p-4 border">{{ item.docRef || '-' }}</td>
                      <td class="p-4 border">{{ item.docDate || '-' }}</td>
                      <td class="p-4 border">{{ item.supplier || '-' }}</td>
                      <td class="p-4 border">{{ formatAmount(item.localAmount) }}</td>
                      <td class="p-4 border">{{ item.company || '-' }}</td>
                      <td class="p-4 border">{{ item.description || '-' }}</td>
                      <td class="p-4 border">
                        <span
                          :class="{
                            'text-green-600 font-semibold': item.status && item.status.toLowerCase() === 'paid',
                            'text-yellow-600 font-semibold': item.status && item.status.toLowerCase() === 'pending',
                            'text-red-600 font-semibold': item.status && item.status.toLowerCase() === 'overdue',
                          }"
                        >
                          {{ item.status || '-' }}
                        </span>
                      </td>
                      <td class="p-4 border">
                        <button
                          @click="selectTransaction(item)"
                          class="bg-[#02A2DC] hover:bg-[#0191b8] text-white p-2 rounded-full flex items-center justify-center mx-auto"
                          title="View"
                        >
                          <span class="material-icons text-sm">visibility</span>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Pagination -->
              <div class="flex flex-col md:flex-row md:items-center md:justify-between mt-4 text-sm gap-2">
                <div class="text-gray-600">
                  Menampilkan
                  <span class="font-semibold">{{ rangeStart }} - {{ rangeEnd }}</span>
                  dari
                  <span class="font-semibold">{{ totalItems }}</span>
                  data
                </div>
                <div class="flex items-center justify-center gap-2">
                  <button
                    class="px-3 py-1 border rounded disabled:opacity-50 disabled:cursor-not-allowed"
                    @click="previousPage"
                    :disabled="currentPage === 1"
                  >
                    Prev
                  </button>
                  <span class="font-semibold">Halaman {{ currentPage }} dari {{ totalPages }}</span>
                  <button
                    class="px-3 py-1 border rounded disabled:opacity-50 disabled:cursor-not-allowed"
                    @click="nextPage"
                    :disabled="currentPage === totalPages"
                  >
                    Next
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Form View (PAYABLE) -->
    <div v-if="showForm" class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="text-lg font-semibold">Payable</h3>

      <button
        @click="handleCancel"
        class="flex items-center text-[#02A2DC] font-medium gap-2 hover:underline mt-2"
      >
        <span class="w-5 h-5 flex items-center justify-center rounded-full border border-[#02A2DC]">
          <span class="material-icons text-[14px] text-[#02A2DC]">arrow_back</span>
        </span>
        View Data
      </button>

      <hr class="border border-gray-200 my-4" />

      <!-- Tombol Aksi -->
      <div class="flex justify-end gap-2 mb-6">
        <button class="btn-primary" @click="handleSave">Save</button>
        <button class="btn-outline" @click="handleCancel">Cancel</button>
        <button class="btn-outline flex items-center gap-1" @click="handlePayment" title="Payment">
          <span class="material-icons text-[16px]">payments</span>
          <span>Payment</span>
        </button>
      </div>

      <!-- Form Fields -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700">Document Number</label>
          <input
            type="text"
            v-model="selectedTransaction.docNo"
            class="w-full border border-gray-300 rounded px-3 py-2 bg-white"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Doc Ref</label>
          <input
            type="text"
            v-model="selectedTransaction.docRef"
            class="w-full border border-gray-300 rounded px-3 py-2 bg-white"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Doc Date</label>
          <input
            type="text"
            v-model="selectedTransaction.docDate"
            class="w-full border border-gray-300 rounded px-3 py-2 bg-white"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Supplier</label>
          <input
            type="text"
            v-model="selectedTransaction.supplier"
            class="w-full border border-gray-300 rounded px-3 py-2 bg-white"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Local Amount</label>
          <input
            type="text"
            v-model="selectedTransaction.localAmount"
            class="w-full border border-gray-300 rounded px-3 py-2 bg-white"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Company</label>
          <input
            type="text"
            v-model="selectedTransaction.company"
            class="w-full border border-gray-300 rounded px-3 py-2 bg-white"
          />
        </div>
        <div class="col-span-1 md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea
            v-model="selectedTransaction.description"
            class="w-full border border-gray-300 rounded px-3 py-2 bg-white"
            rows="2"
          ></textarea>
        </div>
      </div>

      <!-- Payment Panel (optional) -->
      <div v-if="showPaymentForm" class="mt-6 border border-gray-200 rounded p-4 bg-gray-50">
        <h4 class="text-md font-semibold mb-2">Payment</h4>
        <p class="text-sm text-gray-600">Form pembayaran dapat ditambahkan di sini.</p>
      </div>

      <!-- Raw Detail -->
      <div class="max-w-6xl mx-auto px-1 mt-8">
        <h4 class="text-md font-semibold mb-3">Detail Data dari API</h4>
        <div v-if="selectedRawEntries.length" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div
            v-for="([key, value], index) in selectedRawEntries"
            :key="`${key}-${index}`"
            class="border border-gray-200 rounded-md p-3 bg-gray-50"
          >
            <div class="text-xs uppercase text-gray-500 tracking-wide">{{ key }}</div>
            <div class="text-sm font-medium break-words">
              {{ Array.isArray(value) || (value && typeof value === 'object') ? JSON.stringify(value) : value ?? '-' }}
            </div>
          </div>
        </div>
        <div v-else class="text-sm text-gray-500">Tidak ada detail tambahan untuk ditampilkan.</div>
      </div>
    </div>
  </div>
</template>

<script setup>
/**
 * Komponen: Accounting Payable
 * Catatan: Tangani variasi struktur API via normalisasi, jaga UX dengan loading/error/pagination.
 */
import { ref, computed, onMounted, watch } from 'vue'
import { fetchPayables } from 'src/modules/payable'

const showForm = ref(false)
const showPaymentForm = ref(false)
const searchQuery = ref('')
const loading = ref(false)
const errorMessage = ref('')

const transactions = ref([])
const selectedTransaction = ref(createEmptyTransaction())

const itemsPerPage = 10
const currentPage = ref(1)

const filteredTransactions = computed(() => {
  const query = searchQuery.value.trim().toLowerCase()
  if (!query) return transactions.value

  return transactions.value.filter((item) => {
    const searchableString = [
      item.docNo,
      item.docRef,
      item.docDate,
      item.supplier,
      item.company,
      item.description,
      item.status,
      item.localAmount,
      item.raw ? JSON.stringify(item.raw) : '',
    ]
      .filter(Boolean)
      .join(' ')
      .toLowerCase()

    return searchableString.includes(query)
  })
})

const totalItems = computed(() => filteredTransactions.value.length)

const totalPages = computed(() => {
  if (totalItems.value === 0) return 1
  return Math.ceil(totalItems.value / itemsPerPage)
})

const paginatedTransactions = computed(() => {
  const start = (currentPage.value - 1) * itemsPerPage
  const end = start + itemsPerPage
  return filteredTransactions.value.slice(start, end)
})

const rangeStart = computed(() => {
  if (totalItems.value === 0) return 0
  return (currentPage.value - 1) * itemsPerPage + 1
})

const rangeEnd = computed(() => {
  if (totalItems.value === 0) return 0
  return Math.min(currentPage.value * itemsPerPage, totalItems.value)
})

const selectedRawEntries = computed(() => {
  if (!selectedTransaction.value?.raw) return []
  return Object.entries(selectedTransaction.value.raw).sort(([a], [b]) =>
    String(a).localeCompare(String(b)),
  )
})

watch(filteredTransactions, () => {
  currentPage.value = 1
})

onMounted(async () => {
  await loadTransactions()
})

async function loadTransactions() {
  loading.value = true
  errorMessage.value = ''
  try {
    const data = await fetchPayables()
    if (!Array.isArray(data)) throw new Error('Format data dari API tidak valid.')
    transactions.value = data.map((item) => normalizeTransaction(item))
  } catch (error) {
    console.error('Failed to load payable data:', error)
    errorMessage.value = error?.message || 'Terjadi kesalahan ketika mengambil data payable dari server.'
  } finally {
    loading.value = false
  }
}

function createEmptyTransaction() {
  return {
    recordId: null,
    docNo: '',
    docRef: '',
    docDate: '',
    supplier: '',
    localAmount: '',
    company: '',
    description: '',
    status: '',
    raw: null,
  }
}

function pickField(source, keys, fallback = '') {
  if (!source || typeof source !== 'object') return fallback
  for (const key of keys) {
    if (key in source) {
      const value = source[key]
      if (value !== null && value !== undefined && value !== '') return value
    }
  }
  return fallback
}

/** Sanitisasi angka; penting untuk format amount yang bervariasi. */
function parseNumeric(value) {
  if (value === null || value === undefined || value === '') return null
  if (typeof value === 'number') return Number.isFinite(value) ? value : null
  const sanitized = String(value).replace(/[^0-9,-.]/g, '').replace(',', '.')
  const parsed = Number(sanitized)
  return Number.isNaN(parsed) ? null : parsed
}

function normalizeTransaction(item) {
  if (!item || typeof item !== 'object') return createEmptyTransaction()
  const base = item.raw ? { ...item.raw, ...item } : { ...item }
  delete base.raw

  const docNo = pickField(base, ['docNo', 'doc_no', 'document_no', 'DocumentNo', 'DOC_NO'])
  const docRef = pickField(base, ['docRef', 'doc_ref', 'document_ref', 'DocumentRef', 'DOC_REF', 'reference'])
  const docDate = pickField(base, ['docDate', 'doc_date', 'DocumentDate', 'document_date', 'posting_date', 'date'])
  const supplier = pickField(base, ['supplier', 'Supplier', 'vendor', 'Vendor', 'customer', 'Customer'])
  const localAmountRaw = pickField(base, ['localAmount', 'local_amount', 'amount', 'Amount', 'totalAmount', 'total_amount'])
  const company = pickField(base, ['company', 'Company', 'comp_code', 'compCode', 'company_code'])
  const description = pickField(base, ['description', 'Description', 'remarks', 'Remark', 'note'])
  const status = pickField(base, ['status', 'Status', 'payment_status', 'PaymentStatus']) || 'Unpaid'

  const parsedAmount = parseNumeric(localAmountRaw)

  let recordId = pickField(base, ['recordId', 'record_id', 'id', 'ID', 'uuid', 'UUID', 'DocEntry', 'doc_entry'])
  if (!recordId) recordId = docNo || docRef || null
  if (!recordId) {
    try {
      recordId = JSON.stringify(base) // why: fallback unik meski tidak ideal
    } catch {
      recordId = `${Date.now()}-${Math.random()}`
    }
  }

  return {
    recordId,
    docNo: toDisplayString(docNo),
    docRef: toDisplayString(docRef),
    docDate: toDisplayString(docDate),
    supplier: toDisplayString(supplier),
    localAmount: parsedAmount ?? localAmountRaw ?? '',
    company: toDisplayString(company),
    description: toDisplayString(description),
    status: toDisplayString(status),
    raw: base,
  }
}

function toDisplayString(value) {
  if (value === null || value === undefined) return ''
  if (typeof value === 'string') return value
  return String(value)
}

function formatAmount(value) {
  if (value === null || value === undefined || value === '') return '-'
  if (typeof value === 'number') return value.toLocaleString('id-ID')
  const parsed = parseNumeric(value)
  if (parsed === null) return String(value)
  return parsed.toLocaleString('id-ID')
}

function previousPage() {
  if (currentPage.value > 1) currentPage.value -= 1
}
function nextPage() {
  if (currentPage.value < totalPages.value) currentPage.value += 1
}

function selectTransaction(item) {
  const rawClone = item.raw ? JSON.parse(JSON.stringify(item.raw)) : null
  selectedTransaction.value = { ...item, raw: rawClone }
  showForm.value = true
}

function handleSave() {
  const normalized = normalizeTransaction(selectedTransaction.value)
  const index = transactions.value.findIndex((t) => t.recordId === normalized.recordId)
  if (index !== -1) transactions.value.splice(index, 1, normalized)
  else transactions.value.push(normalized)
  showForm.value = false
  selectedTransaction.value = createEmptyTransaction()
}

function handleCancel() {
  selectedTransaction.value = createEmptyTransaction()
  showForm.value = false
}

function handlePayment() {
  showPaymentForm.value = !showPaymentForm.value
}
</script>

<style scoped>
table {
  border-collapse: collapse;
}

th,
td {
  text-align: center;
  vertical-align: middle;
}

th {
  background-color: #02a2dc;
  color: white;
  font-weight: bold;
  text-transform: none;
}

/* Tombol util sederhana */
.btn-primary {
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  color: #fff;
  background-color: #02A2DC;
  transition: background-color 0.2s;
}
.btn-primary:hover {
  background-color: #0191b8;
}

.btn-outline {
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  border: 1px solid #d1d5db;
  color: #374151;
  background-color: transparent;
  transition: background-color 0.2s;
}
.btn-outline:hover {
  background-color: #f9fafb;
}
</style>
